这部分是开发记录，用于后面修改参考。

# 正文

转接仙人WCH早些时候出了个 ch347，包含了JTAG，串口等接口，但是用的是他自己的驱动（很神秘，安装驱动叫ch341），可以通过 openocd 对xilinx的fpga的下载，也可以通过一个开源项目的比特流编程flash，但是显然不能通过vivado直接使用。（但是可以使用xvc来实现转接）。

今年做板子的时候找接口芯片的时候观察了一下，发现ch32v305几乎和ch347一模一样，具有480M的USBHS PHY，而且官方开源了一个open-usb-jtag的工程可以用于ch32v305，感觉按照wch的尿性，ch347大概就是个特殊版单片机，可以完全实现替换兼容（需要修改官方开源版程序的外设和引脚使用）

改了之后使用这个工程确实也可以用openocd下载比特流，原则上来说这时候可以修改xvc来实现虚拟电缆，不过这个还是有点麻烦，而且似乎有什么限制？

```cmd
.\openocd.exe -f .\usb20jtag.cfg -f ..\scripts\cpld\xilinx-xc7.cfg -c "init; xc7_program xc7.tap; pld load 0 led.bit" -c exit
```



然后找到了一个开源工程，可以把ch32v305模拟成ft2232d，响应对应的USB请求，这个实现比较完整，对eeprom的读取也做了实现，但是vivado不只是需要这些。

直接说结论，原版是按照ft2232d和93c46eeprom来实现的，需要修改为ft2232h，修改描述符中的bcd device，也可以修改为ft4232或者232，不过注意，这几个的EEPROM内容的布局都不一样.

index需要修改，原来按照93c46设计，直接改到0x80或者0x100（93c66），这里目前做了宏定义来区分。

而eeprom的内容中有几个关键位置必须对，否则即使ft_prog读取对的，vivado tcl读取也是对的，但是vivado就是不会认的。。

第一位，可能和器件有关，ftdi手册也没说应该是啥，0x584a前的一个数字，和器件有关，应该是vivado自定义的，最后一个可能是校验位的倒是不影响，随便改都没事。

参考博客中博客中有一些猜测，但是不完全。

这里按照差异修改出来了一个，一开始好像可以用，后来不知道是我一不小心改错了还是咋了，又不行了，所以：

最简单的办法就是找个ft2232的板子读出来。。

这里可以写个程序把复制粘贴的内容转成数组，不过我是直接让deepseek给我打印



其实这些都不耽误调用FTDI API，vivado就是有病，xilinx罪大恶极，但是2022版本却放宽了限制，不知道以后会不会改掉这个限制（大概是不会动这个![img](./开发说明_att/I`Q{A5T7DK7QUG@%L46]3T.png)山了)

修改过程中我发现我改的代码只在第一次插上有效，后面就会卡住，我实在不记得最开始是不是这样了，我有点怀疑是不是我debug加多了，最后一顿Debug后打印请求发现是vivado会在结束server的时候发送请求把超时设置为3，这时候代码会错过发送出ep内容就超时了，导致状态锁死。解决办法很简单，这里写死保持16ms。。。。或者忽略那个设置，后者似乎更好 这样会读的时候是一致的 只是这里没有用上。

FT232H不能使用93C46(只要是46都不行，和中间的字母没关系），所以模拟的只能按照93C56来做。不过实际上FT_Prog确实可以识别型号，只是不支持读写。

ps：神奇的问题，ft2232买到手的时候，eeprom不知道是不是没焊接好还是没焊接org上拉电阻，显示没有eeprom（按照手册不焊上拉电阻是可以的，之前在232上试过能识别型号，只是232不支持93C46），读出来的设备是FT4232。

# CherryUSB

挺好用的，一看就懂，感觉比tinyusb好用。

这里有一些请求没完全处理，先这么用着吧。

## 吐槽WCH

之前是支持wch-link的，但是实际上不咋好用，一顿复位才能下进去。

开发板上的下载器还用着用着突然挂了浪费我两天时间重新买一个然后给他下载成调试器（在WCH下载工具安装目录下有固件）

遇到过一起eeprom内容清空的清空（FF),不知道原因

# Wireshark USB抓包

需要USBCAP这里只能看到协议的数据包，不过这里在通信已经正常的情况下够用了。

便携版不行，得安装
linux可以用USBMON

勾选插入枚举，这样可以自动识别库中记录的协议，很方便分析，包括FTDI MPSSE，可以根据分析来一个一个看，比看一堆HEX好多了。

这软件也挺神秘的，过多内容排序的时候会出现wireshark increase cache in layout prefeerence，还要手动调整，不过毕竟人家免费，凑合用吧。

而且经常重启卡住，得重新打开软件，不知道是不是这个版本不搭。

# 参考内容

[FTDI MPSSE Basics](https://ftdichip.com/Support/Documents/AppNotes/AN_135_MPSSE_Basics.pdf)

[AN_108_Command_Processor_for_MPSSE_and_MCU_Host_Bus_Emulation_Modes.pdf](https://ftdichip.com/Support/Documents/AppNotes/AN_108_Command_Processor_for_MPSSE_and_MCU_Host_Bus_Emulation_Modes.pdf)

[D2XX EEPROM Programming Examples](https://ftdichip.com/Support/Documents/AppNotes/AN_428 D2XX EEPROM Programming Examples.pdf)

[D2XX Programmer's Guide](https://dlpdesign.com/drivers/D2XXPG21.pdf)

[Microsoft Word - AN_127_User_Guide_For_FT2232HD_Factory test utility](https://ftdichip.com/wp-content/uploads/2020/07/AN_127_User_Guide_For_FT2232HD_Factory-test-utility.pdf)

[Microsoft Word - AN_121_FTDI_Device_EEPROM_User_Area_Usage_new](https://ftdichip.com/Documents/AppNotes/AN_121_FTDI_Device_EEPROM_User_Area_Usage.pdf)

[AN_129_FTDI_Hi_Speed_USB_To_JTAG_Example.pdf](https://www.ftdichip.cn/Support/Documents/AppNotes/AN_129_FTDI_Hi_Speed_USB_To_JTAG_Example.pdf)

[Programming FTDI Devices for Vivado Hardware Manager Support • Vivado Design Suite User Guide: Programming and Debugging (UG908)](https://docs.amd.com/r/en-US/ug908-vivado-programming-debugging/Programming-FTDI-Devices-for-Vivado-Hardware-Manager-Support)

[Xilinx JTAG Support on FTDI](https://etherealwake.com/2024/06/xilinx-ftdi-jtag/)

[GitHub - hdl-libs/PROGRAM_FTDI: PROGRAM_FTDI 是一个用于设置和管理 基于 FT232/FT2232/FT4232 的 Xilinx JTAG 设备的序列号信息 Windows Forms 应用程序](https://github.com/hdl-libs/PROGRAM_FTDI)

[GitHub - openwch/usb-jtag-spi: Single-chip solution for Hi-speed USB2.0(480Mbps) JTAG/SPI Debugger based on RISC-V MCU CH32V30x/CH32V20x](https://github.com/openwch/usb-jtag-spi)

CH32FV2x_V3xRM.PDF

IEEE_1149_JTAG_and_Boundary_Scan_Tutorial.pdf

IEEE-Std-1149.1-2001.pdf

[USB CONFIG 说明 — CherryUSB 1.5.2 文档](https://cherryusb.readthedocs.io/zh-cn/latest/api/api_config.html)



[STM32_USB_Simulates_FT232: 用STM32模拟FT232 - Gitee.com](https://gitee.com/yijing6513/stm32_-usb_-simulates_-ft232/tree/master/Source_Files)

